name: Alert on Failure

on:
  workflow_run:
    workflows:
      - Update Boston Dynamics RSS
      - Update Area Feeds (AI/Robotics/Quantum/Biotech/Nanotech)
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  create-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Open/append failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run = context.payload.workflow_run;
            const title = `❌ Workflow failed: ${run.name}`;
            const body = [
              `Run: ${run.html_url}`,
              `Branch: ${run.head_branch}`,
              `Event: ${run.event}`,
              `Commit: ${run.head_sha}`
            ].join('\n');

            // Ensure label exists (idempotent)
            const labelName = 'ci-failure';
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch {
              await github.rest.issues.createLabel({
                owner, repo, name: labelName, color: 'B60205', description: 'CI workflow failure'
              });
            }

            // Find existing issue for this workflow
            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo, state: 'open', labels: labelName, per_page: 100
            });
            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({ owner, repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({
                owner, repo, title, body, labels: [labelName]
              });
            }

  close-issue-on-recovery:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Close failure issue if open
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run = context.payload.workflow_run;
            const title = `❌ Workflow failed: ${run.name}`;
            const labelName = 'ci-failure';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo, state: 'open', labels: labelName, per_page: 100
            });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: existing.number,
                body: `✅ Recovery: ${run.html_url}`
              });
              await github.rest.issues.update({
                owner, repo, issue_number: existing.number, state: 'closed'
              });
            }
