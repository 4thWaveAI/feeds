name: Alert on Failure

on:
  workflow_run:
    workflows:
      - Update Boston Dynamics RSS
      - Update Area Feeds (AI/Robotics/Quantum/Biotech/Nanotech)
    types: [completed]

jobs:
  create-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Open/append failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `âŒ Workflow failed: ${context.payload.workflow_run.name}`;
            const body = [
              `Run: ${context.payload.workflow_run.html_url}`,
              `Branch: ${context.payload.workflow_run.head_branch}`,
              `Event: ${context.payload.workflow_run.event}`,
              `Commit: ${context.payload.workflow_run.head_sha}`
            ].join('\n');
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: 'open', labels: 'ci-failure' });
            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({ owner, repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({
                owner, repo, title, body, labels: ['ci-failure']
              });
            }
